<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ADMIN CMS - GI</title>
    <link href="/admin/config.yml" type="text/yaml" rel="cms-config-url">
</head>
<body>
    <script src="https://unpkg.com/decap-cms@3.9.0/dist/decap-cms.js"></script>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        const getYoutubeId = (url) => {
            if (!url) return null; // N·∫øu kh√¥ng c√≥ url => tr·∫£ v·ªÅ null
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        };
        CMS.registerEditorComponent({
            id: "youtube",
            label: "YouTube",
            fields: [{
                name: 'url',
                label: 'Youtube URL',
                widget: 'string',
                hint: 'D√°n ƒë∆∞·ªùng d·∫´n video v√†o ƒë√¢y.'
            }],
            pattern: /^<iframe.+src="https:\/\/www\.youtube\.com\/embed\/([^"]+)".+<\/iframe>$/,
            fromBlock: function(match) {
                return {
                    url: 'https://www.youtube.com/watch?v=' + match[1]
                };
            },
            toBlock: function(obj) {
                const id = getYoutubeId(obj.url);
                return '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + id + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>';
            },
            toPreview: function(obj) {
                const id = getYoutubeId(obj.url);
                if (!id) return '<div style="color: #888; background: #eee; padding: 10px; border-radius: 5px; text-align: center; border: 1px dashed #ccc;">üîó ƒêang ch·ªù d√°n ƒë∆∞·ªùng d·∫´n Youtube...</div>';
                return '<iframe width="560" height="315" src="https://www.youtube.com/embed/' + id + '" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>';
            }
        });

        CMS.registerEventListener({
            name: 'preSave',
            handler: ({ entry }) => {
                const data = entry.get('data');
                if (data.has('body')) {
                    let body = data.get('body');
                    let originalBody = body;
                    if (body) {
                        body = body.replace(/\*\s+([\"‚Äú‚Äù])/g, '*$1');
                        body = body.replace(/([\"‚Äú‚Äù])\s+\*/g, '$1*');
                        body = body.replace(/([‚Äú"'])\*/g, '*$1');
                        body = body.replace(/\*([‚Äù"'])/g, '$1*');
                        if (body !== originalBody) {
                            return data.set('body', body);
                        }
                    }
                }
                return data;
            },
        });
    </script>
</body>
</html>